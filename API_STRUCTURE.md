# ReMind API Structure

**Version:** 2.0.0
**Architecture:** Therapist → Admin → Patient

## 🏗️ API Organization

The API is organized into three main sections following the workflow:

### 1. **Therapist Endpoints** (`/therapist/*`)
Therapists create and manage memory experiences for patients.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/therapist/create-experience` | POST | Create a new memory experience for the patient |
| `/therapist/experiences` | GET | List all experiences created by therapist |
| `/therapist/experience/{id}` | DELETE | Delete an experience |

**Example Flow:**
```bash
# Therapist creates experience
curl -X POST http://localhost:8000/therapist/create-experience \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Beach Day with Anna",
    "general_context": "me and Anna at the beach",
    "scenes": ["holding hands", "eating ice cream"],
    "top_k": 3
  }'

# Returns: experience_id and patient_url
```

---

### 2. **Patient Endpoints** (`/patient/*`)
Patients view experiences and interact with their memories.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/patient/experience/{id}` | GET | View a specific experience created by therapist |
| `/patient/experiences` | GET | List all available experiences |
| `/patient/query` | POST | Ask questions about memories (6-mode AI response) |
| `/patient/query-test` | POST | Test query endpoint (text input, no audio) |

**6-Mode Response System:**
- **4-pic**: 4 images + narration text
- **3-pic**: 3 images + narration text
- **5-pic**: 5 images + narration text
- **video**: Horizontal video + narration text
- **vertical-video**: Vertical video + narration text
- **agent**: Conversational lip-sync video (no text)

**Example Flow:**
```bash
# Patient views experience
curl http://localhost:8000/patient/experience/{experience_id}

# Patient asks question
curl -X POST http://localhost:8000/patient/query \
  -F "audio_file=@patient_audio.mp3" \
  -F "topic=Avery"

# Test without audio
curl -X POST http://localhost:8000/patient/query-test \
  -F "transcription=I want to learn about the beach day" \
  -F "topic=Avery"
```

---

### 3. **Admin Endpoints** (`/admin/*`)
System administrators manage data pipeline and storage.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/admin/metadata/build` | POST | Build metadata CSV from GCS context files |
| `/admin/metadata/count` | GET | Get count of metadata rows |
| `/admin/upload/snowflake` | POST | Upload metadata to Snowflake MEMORY_VAULT |
| `/admin/upload/gcs` | POST | Upload files to Google Cloud Storage |

**Example Flow:**
```bash
# Build metadata from GCS
curl -X POST http://localhost:8000/admin/metadata/build

# Upload to Snowflake
curl -X POST http://localhost:8000/admin/upload/snowflake \
  -H "Content-Type: application/json" \
  -d '{"csv_path": "data/metadata.csv", "truncate_existing": true}'
```

---

## 🔄 Complete Workflow

```
1. [ADMIN] Build metadata from GCS
   POST /admin/metadata/build
   ↓
2. [ADMIN] Upload to Snowflake
   POST /admin/upload/snowflake
   ↓
3. [THERAPIST] Create memory experience
   POST /therapist/create-experience
   ↓
4. [PATIENT] View experience
   GET /patient/experience/{id}
   ↓
5. [PATIENT] Ask questions about memories
   POST /patient/query
   ↓
6. [SYSTEM] AI classifies intent → Returns 6-mode response
```

---

## 📋 Key Features

### Intent Classification
- **Gemini-powered** analysis of patient requests
- Determines display mode based on:
  - Intent type (memory replay vs conversation)
  - Available media in Snowflake
  - Emotional tone and context

### Memory Retrieval
- **Vector similarity search** using Snowflake Cortex
- **Semantic embeddings** (e5-base-v2, 768 dimensions)
- Returns top-k relevant memories

### Response Generation
- **Warm narration** generated by Gemini
- **Emotionally supportive** language
- **Personalized** to patient's request

---

## 🚀 Quick Start

```bash
# Start server
uvicorn main:app --reload --port 8000

# View API docs
open http://localhost:8000/docs

# Check health
curl http://localhost:8000/
```

---

## 📂 File Structure

```
api/
├── experiences.py        → Therapist endpoints
├── patient_query.py      → Patient endpoints
├── metadata.py          → Admin metadata endpoints
├── upload.py            → Admin upload endpoints
├── intent_classifier.py → 6-mode classification logic
├── schemas.py           → Pydantic models
└── memories.py          → (Deprecated - use patient/query)
```

---

## 🔒 Removed/Deprecated Endpoints

The following endpoints have been **removed or reorganized**:

- ❌ `/experiences/*` → Renamed to `/therapist/*`
- ❌ `/metadata/*` → Moved to `/admin/metadata/*`
- ❌ `/upload/*` → Moved to `/admin/upload/*`
- ⚠️ `/memories/search` → Kept for backwards compatibility (use `/patient/query` instead)
- ❌ `/transcribe/*` → Integrated into `/patient/query`

---

## 📝 Notes

- **In-memory storage**: Experiences currently stored in memory (use Redis/DB for production)
- **Auto-assignment**: All experiences auto-assigned to patient (no multi-patient support yet)
- **Veo integration**: Placeholder for video generation (to be implemented)
- **Agent mode**: ElevenLabs integration pending (returns placeholder video)
